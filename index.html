<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>üé≤ Farkle</title>

<link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
<script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

<style>
  body { font-family: sans-serif; }
  .die { font-size: 22px; padding: 10px; margin: 4px; }
  .selected { background: gold; }
  .locked { background: lightgreen; }
</style>
</head>

<body>
<h1>üé≤ Farkle</h1>

<button onclick="startGame()">Start Game</button>
<button onclick="rollDice()">Roll</button>
<button onclick="lockDice()">Lock Dice</button>
<button onclick="bankPoints()">Bank Points</button>

<div id="output"></div>
<div id="dice"></div>
<div id="scoreboard"></div>

<script type="py">
import random
from collections import Counter
from js import window

# ---------------- STATE ----------------
players = []
scores = []
current_player = 0

turn_score = 0
dice_left = 6

current_roll = []
selected = []
locked_dice = []

# ---------------- SCORING ----------------
def score_dice(dice):
    counts = Counter(dice)
    values = sorted(counts.values())

    if sorted(dice) == [1,2,3,4,5,6]: return 1500, 6
    if values == [3,3]: return 2500, 6
    if values == [2,2,2]: return 1500, 6
    if values == [2,4]: return 1500, 6

    score = used = 0
    for num, cnt in counts.items():
        if cnt >= 3:
            score += 1000 if num == 1 else num * 100
            used += cnt
            counts[num] = 0

    score += counts[1] * 100
    used += counts[1]
    score += counts[5] * 50
    used += counts[5]

    return score, used

# ---------------- UI ----------------
def render():
    d = window.document.getElementById("dice")
    d.innerHTML = ""

    for i, die in enumerate(current_roll):
        cls = "selected" if i in selected else ""
        d.innerHTML += f"<button class='die {cls}' onclick='toggleDie({i})'>{die}</button>"

    for die in locked_dice:
        d.innerHTML += f"<button class='die locked'>{die}</button>"

    update_scoreboard()

def update_scoreboard():
    html = "<h3>Scores</h3>"
    for i, p in enumerate(players):
        arrow = "‚û°Ô∏è" if i == current_player else ""
        html += f"{arrow} {p}: {scores[i]}<br>"
    window.document.getElementById("scoreboard").innerHTML = html

# ---------------- GAME ACTIONS ----------------
def toggle_die(i):
    if i in selected:
        selected.remove(i)
    else:
        selected.append(i)
    render()

window.toggleDie = toggle_die

def roll():
    global current_roll, selected

    if dice_left == 0:
        hot_dice()

    current_roll = [random.randint(1,6) for _ in range(dice_left)]
    selected.clear()
    render()

    # Auto Farkle detection
    score, _ = score_dice(current_roll)
    if score == 0:
        farkle()

def lock():
    global dice_left, turn_score

    if not selected:
        window.document.getElementById("output").innerHTML = "Select scoring dice!"
        return

    chosen = [current_roll[i] for i in selected]
    score, used = score_dice(chosen)

    if score == 0:
        window.document.getElementById("output").innerHTML = "Invalid dice selection"
        return

    turn_score += score
    dice_left -= used
    locked_dice.extend(chosen)

    for i in sorted(selected, reverse=True):
        del current_roll[i]

    selected.clear()
    render()

def bank():
    global current_player, turn_score, dice_left

    scores[current_player] += turn_score
    next_player()

def farkle():
    window.document.getElementById("output").innerHTML = "üî• FARKLE!"
    next_player()

def hot_dice():
    global dice_left
    dice_left = 6
    locked_dice.clear()
    window.document.getElementById("output").innerHTML = "üî• HOT DICE!"

def next_player():
    global current_player, turn_score, dice_left, current_roll, locked_dice, selected
    turn_score = 0
    dice_left = 6
    current_roll = []
    locked_dice = []
    selected = []
    current_player = (current_player + 1) % len(players)
    render()

# ---------------- START ----------------
def start_game():
    global players, scores, current_player
    n = int(window.prompt("How many players?"))
    players = [window.prompt(f"Player {i+1} name") for i in range(n)]
    scores = [0]*n
    current_player = 0
    next_player()

# ---------------- EXPOSE ----------------
window.rollDice = roll
window.lockDice = lock
window.bankPoints = bank
window.startGame = start_game
</script>
</body>
</html>
