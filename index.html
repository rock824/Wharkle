<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ðŸŽ² Farkle</title>

  <!-- PyScript -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
  <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
</head>

<body>
  <h1>ðŸŽ² Farkle</h1>

  <button id="rollBtn">Roll Dice</button>
  <button id="holdBtn">Hold</button>

  <div id="output"></div>

  <!-- THIS IS THE KEY CHANGE -->
<script type="py">
import random
from collections import Counter
from js import document, window

dice_left = 6
turn_score = 0
total_score = 0

def speak(text):
    utterance = window.SpeechSynthesisUtterance.new(text)
    window.speechSynthesis.speak(utterance)

def score_dice(dice):
    counts = Counter(dice)
    score = 0
    used = 0
    values = sorted(counts.values())

    # ---- SPECIAL 6-DICE COMBOS ----
    if sorted(dice) == [1,2,3,4,5,6]:
        return 1500, 6

    if values == [2,2,2]:
        return 1500, 6  # three pairs

    if values == [3,3]:
        return 2500, 6  # two triplets

    if values == [2,4]:
        return 1500, 6  # four of a kind + a pair

    # ---- OF-A-KIND SCORING ----
    for num, count in counts.items():
        if count >= 3:
            if count == 3:
                score += 1000 if num == 1 else num * 100
            elif count == 4:
                score += 1000
            elif count == 5:
                score += 2000
            elif count == 6:
                score += 3000
            used += count
            counts[num] = 0

    # ---- SINGLE DIE SCORING ----
    score += counts[1] * 100
    used += counts[1]

    score += counts[5] * 50
    used += counts[5]

    return score, used

def roll(*args):
    global dice_left, turn_score
    dice = [random.randint(1, 6) for _ in range(dice_left)]
    score, used = score_dice(dice)

    if score == 0:
        document.getElementById("output").innerHTML = "ðŸ”¥ FARKLE!"
        speak("Farkle!")
        reset_turn()
    else:
        turn_score += score
        dice_left -= used
        document.getElementById("output").innerHTML = (
            f"Rolled: {dice}<br>"
            f"Scored: {score}<br>"
            f"Turn total: {turn_score}"
        )
        speak(f"You scored {score} points")

    if dice_left == 0:
        dice_left = 6

def hold(*args):
    global total_score, turn_score
    total_score += turn_score
    document.getElementById("output").innerHTML = (
        f"Held! Total score: {total_score}"
    )
    speak(f"Total score is {total_score}")
    reset_turn()

def reset_turn():
    global dice_left, turn_score
    dice_left = 6
    turn_score = 0

# ðŸ”‘ EXPOSE FUNCTIONS TO JS
window.rollDice = roll
window.holdDice = hold
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("rollBtn").addEventListener("click", () => {
    window.rollDice()
  })

  document.getElementById("holdBtn").addEventListener("click", () => {
    window.holdDice()
  })
})
</script>
